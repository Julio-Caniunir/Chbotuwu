<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chatbox</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background-color: #f4f4f4;
    }
  
    .chat-container {
      width: 300px; /* Tamaño reducido */
      max-width: 90%; /* Adaptable a pantallas pequeñas */
      height: 500px; /* Altura específica */
      background-color: #fff;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      border-radius: 10px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
  
    .chat-header {
      background-color: #007bff;
      color: white;
      padding: 10px 15px;
      text-align: center;
      font-size: 18px; /* Tamaño de fuente más pequeño */
      font-weight: bold;
    }
  
    .chat-messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto; /* Habilita el scroll interno */
      background-color: #f9f9f9;
    }
  
    .chat-messages .message {
      margin-bottom: 10px;
      padding: 8px;
      border-radius: 8px;
      max-width: 80%;
      word-wrap: break-word;
      font-size: 14px; /* Tamaño de texto ajustado */
      line-height: 1.4;
    }
  
    .chat-messages .message.user {
      background-color: #007bff;
      color: white;
      align-self: flex-end;
    }
  
    .chat-messages .message.bot {
      background-color: #e0e0e0;
      color: black;
      align-self: flex-start;
    }
  
    .chat-input {
      display: flex;
      padding: 10px;
      border-top: 1px solid #ddd;
      background-color: #fff;
    }
  
    .chat-input input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 20px;
      outline: none;
      font-size: 14px;
    }
  
    .chat-input button {
      margin-left: 10px;
      padding: 10px 15px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
    }
  
    .chat-input button:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      <h2>Chat</h2>
    </div>
    <div class="chat-messages" id="chatMessages">
      <!-- Los mensajes aparecerán aquí -->
    </div>
    <div class="chat-input">
      <input type="text" id="messageInput" placeholder="Escribe tu mensaje..." />
      <button id="sendButton">Enviar</button>
    </div>
  </div>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const chatMessages = document.getElementById("chatMessages");
      const messageInput = document.getElementById("messageInput");
      const sendButton = document.getElementById("sendButton");
  
      let step = 0; // Controla las preguntas
      let country = ""; // Guardará el país ingresado
      let languagePreference = ""; // Guardará el idioma ingresado
      let category = ""; // Guardará la categoría ingresada
  
      const apiUrl = "/api"; // Endpoint de la función serverless
  
      const addMessage = (text, sender, isLink = false) => {
        const message = document.createElement("div");
        message.classList.add("message", sender);
  
        if (isLink) {
          const link = document.createElement("a");
          link.href = text.url;
          link.textContent = text.title;
          link.target = "_blank"; // Abrir en nueva pestaña
          link.style.color = sender === "bot" ? "black" : "white"; // Ajusta el color según el remitente
          message.appendChild(link);
        } else {
          message.textContent = text;
        }
  
        chatMessages.appendChild(message);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      };
  
      const fetchContent = async (pais, idioma, categoria) => {
        try {
          const response = await fetch(
            `${apiUrl}?pais=${pais}&idioma=${idioma}&categoria=${categoria}`
          );
  
          if (!response.ok) throw new Error("Error al conectar con la función de Netlify.");
  
          const data = await response.json();
          displayPromotions(data);
        } catch (error) {
          console.error(error);
          addMessage("Hubo un error al obtener las promociones. Por favor, intenta más tarde.", "bot");
        }
      };
  
      const displayPromotions = (data) => {
        if (data && data.data && Array.isArray(data.data) && data.data.length > 0) {
          data.data.forEach((item) => {
            addMessage({ title: item.title, url: item.url }, "bot", true);
          });
        } else {
          addMessage("No se encontraron promociones para los datos ingresados.", "bot");
        }
      };
  
      const askQuestion = () => {
        if (step === 0) {
          addMessage("¡Hola! ¿De qué país eres? (Ejemplo: CL, PE)", "bot");
        } else if (step === 1) {
          addMessage("¿Prefieres la información en Inglés o Español? (EN/ES)", "bot");
        } else if (step === 2) {
          addMessage("¿Qué categoría prefieres? (casino/deportes)", "bot");
        } else if (step === 3) {
          addMessage("Buscando promociones, por favor espera...", "bot");
          fetchContent(country, languagePreference, category);
        }
      };
  
      sendButton.addEventListener("click", () => {
        const messageText = messageInput.value.trim().toLowerCase();
        if (!messageText) return;
  
        addMessage(messageText, "user");
  
        if (step === 0) {
          if (messageText.match(/^[a-z]{2}$/i)) {
            country = messageText.toUpperCase();
            step++;
            askQuestion();
          } else {
            addMessage("Por favor, ingresa un código de país válido (Ejemplo: CL, PE).", "bot");
          }
        } else if (step === 1) {
          if (messageText === "en" || messageText === "es") {
            languagePreference = messageText.toUpperCase();
            step++;
            askQuestion();
          } else {
            addMessage("Por favor, responde con EN o ES.", "bot");
          }
        } else if (step === 2) {
          if (messageText === "casino" || messageText === "deportes") {
            category = messageText;
            step++;
            askQuestion();
          } else {
            addMessage("Por favor, responde con 'casino' o 'deportes'.", "bot");
          }
        }
  
        messageInput.value = ""; // Limpiar el campo de entrada
      });
  
      messageInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          sendButton.click();
        }
      });
  
      // Inicia la conversación
      askQuestion();
    });
  </script>
  
  
  
</body>
</html>